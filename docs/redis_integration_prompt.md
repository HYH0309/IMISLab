# Redis 集成开发任务说明

## 目标

为 IMISLab 项目集成 Redis 实现以下功能：

1. 基于 IP 的阅读量统计（带防刷机制）
2. OJ 代码提交频率限制
3. 热门文章内容缓存

## 技术规范

### Redis 配置要求

- 使用官方 `redis:alpine` 镜像
- 端口映射：6379:6379
- 内存限制：最大 1GB
- 持久化：RDB 快照每 5 分钟

### 功能实现规范

#### 1. 阅读量统计

- **接口**：`GET /api/article/:id`
- **存储结构**：

  ```redis
  # 文章总阅读量（永久存储）
  SET article:views:{id} [count]
  
  # IP 访问记录（60 秒过期）
  SET article:ip:{id}_{ip} 1 EX 60
  ```

- **防刷机制**：同一 IP 对同篇文章 60 秒内只计 1 次

#### 2. OJ 提交限流

- **接口**：`POST /api/oj/submit`
- **限流规则**：同一 IP 每分钟最多 5 次提交
- **存储结构**：

  ```redis
  # 提交计数（60 秒过期）
  SET oj:submit:{ip} [count] EX 60
  ```

#### 3. 热点文章缓存

- **缓存条件**：阅读量 > 100 的文章
- **缓存时间**：10 分钟
- **存储结构**：

  ```redis
  # 文章内容缓存
  SET article:content:{id} [json] EX 600
  ```

## 实现要求

### 配置扩展

1. 在 `backend/config/db.go` 添加 Redis 配置结构
2. 在 `docker-compose.yml` 添加 Redis 服务

### 服务初始化

1. 在 `backend/main.go` 初始化 Redis 连接池
2. 实现健康检查 `redis.Ping()`

### 定时任务

1. 实现 5 分钟定时器同步阅读量到数据库
2. 使用 goroutine 安全退出机制

### 代码风格

1. 保持现有 Golang 代码规范
2. 关键函数添加注释说明 Redis 操作
3. 错误处理使用统一日志系统

## 注意事项

1. 阅读量同步任务需考虑并发安全
2. 热点缓存需设置合理的 TTL
3. 所有 Redis 操作需处理连接错误
4. 添加 Redis 指标监控（可选）

## 验收标准

1. 阅读量统计准确（带防刷验证）
2. OJ 提交超过 5 次/分钟返回 429 状态码
3. 热门文章响应时间减少 50%
4. 通过基础压力测试（1000 次/秒）

## 实施步骤

1. 基础 Redis 配置（Docker + 连接初始化）
2. 阅读量统计功能
3. OJ 提交限流
4. 热点文章缓存

预计开发时间：2-3 个工作日
